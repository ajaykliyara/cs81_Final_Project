---
title: "Untitled"
author: "Will Williamson"
date: "November 28, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load libraries
library(stringr)
library(plyr)
library(lubridate)
library(randomForest)
library(reshape2)
library(ggplot2)
library(zoo)
library(dplyr)
```

```{r}
# read the csv data file
df <- read.csv("data/LoanStats3a_securev1.csv", header = TRUE, 
                    stringsAsFactors = F, skip = 1)

#get rid of fields that are 80% NA
poor_coverage <- sapply(df, function(x) {
  coverage <- 1 - sum(is.na(x)) / length(x)
  coverage < 0.8
})
df <- df[,poor_coverage==FALSE]

# delete columns that are not going to help
col_to_delete <- c("id", "member_id", "funded_amnt", "funded_amnt_inv", "int_rate",
                   "installment", "emp_title", "verification_status", "issue_d",
                   "pymnt_plan", "url", "desc", "purpose", "title", "zip_code",
                   "initial_list_status", "out_prncp", "out_prncp_inv", 
                   "total_pymnt", "total_pymnt_inv",
                   "total_rec_prncp", "total_rec_int", "total_rec_late_fee",
                   "recoveries", "collection_recovery_fee", "last_pymnt_d",
                   "last_pymnt_amnt", "next_pymnt_d", "last_credit_pull_d",
                   "last_fico_range_high", "last_fico_range_low", "application_type",
                   "policy_code", "earliest_cr_line", "grade", "sub_grade")
df <- df %>% select(-one_of(col_to_delete))

# clean up emp_length column
df$emp_length <- str_match(df$emp_length, "[0123456789+]")
df$emp_length <- as.numeric(df$emp_length)

# remove '%' from revol_util
df$revol_util <- gsub("%", "", df$revol_util)

# average fico high and low
df <- df %>% 
  mutate(fico = (fico_range_high + fico_range_low) / 2) %>%
  select(-c(fico_range_high, fico_range_low)) 

# Remove all remaining rows with NA's
df <- na.omit(df)

# may want to experiment with removing late
# create a good / bad column
# bad if late more than 30 days, in default, or charged off
bad_indicators <- c("Late (31-120 days)", "Default", "Charged Off")
df <- df %>% 
  mutate(is_bad = ifelse(df$loan_status %in% bad_indicators, 1, 0)) %>%
  select(-loan_status)

# remove "months" from the term column
df$term <- str_match(df$term, "[0123456789+]")

# remove columns which are all zeros
all_zeros <- sapply(df, function(x) {
  col_sum = 1
  if (is.numeric(x)){
      col_sum = sum(x)
  }
  col_sum == 0
})
df <- df[,all_zeros==FALSE]
```

```{r}
df$is_bad <- ifelse(df$loan_status %in% bad_indicators, 1,
                         ifelse(df$loan_status == "", NA, 0))
table(df$loan_status)
table(df$is_bad)

head(df)
date_format <- "%b-%Y"
df$yearmon <- as.Date(as.yearmon(df$issue_d,date_format))
df$year_issued <- year(as.yearmon(df$issue_d, date_format))
df$month_issued <- month(as.yearmon(df$issue_d, date_format))
df$earliest_cr_line <- as.Date(as.yearmon(df$earliest_cr_line, date_format))
df$revol_util <- str_replace_all(df$revol_util, "[%]", "")
df$revol_util <- as.numeric(df$revol_util)

outcomes <- ddply(df, .(year_issued, month_issued), function(x) {
  c("percent_bad"=sum(x$is_bad) / nrow(x),
    "n_loans"=nrow(x))
})

plot(outcomes$percent_bad, main="Bad Rate")
outcomes
```

```{r}
#figure out which columns are numeirc (and hence we can look at the distribution)
numeric_cols <- sapply(df, is.numeric)
#turn the data into long format (key->value esque)
df.lng <- melt(df[,numeric_cols], id="is_bad")
head(df.lng)

#plot the distribution for bads and goods for each variable
p <- ggplot(aes(x=value, group=is_bad, colour=factor(is_bad)), data=df.lng)
#quick and dirty way to figure out if you have any good variables
p + geom_density() + facet_wrap(~variable, scales="free")
```

```{r}
df.term <- subset(df, year_issued < 2012)
df.term$home_ownership <- factor(df.term$home_ownership)
df.term$is_rent <- df.term$home_ownership=="RENT"
df.term$fico_range <- factor(df.term$fico_range)
df.term$fico_ordered <- as.numeric(df.term$fico_range)

idx <- runif(nrow(df.term)) > 0.75
train <- df.term[idx==FALSE,]
test <- df.term[idx==TRUE,]


rf <- randomForest(factor(is_bad) ~ last_fico_range_high + last_fico_range_low +
                     pub_rec_bankruptcies + revol_util + inq_last_6mths + is_rent,
type="classification", data=train, importance=TRUE, na.action=na.omit)
```

