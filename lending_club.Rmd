---
title: "Untitled"
author: "Will Williamson"
date: "November 28, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load libraries
library(stringr)
library(plyr)
library(lubridate)
library(randomForest)
library(reshape2)
library(ggplot2)
library(zoo)
library(dplyr)
```

```{r}
# read the csv data file
df <- read.csv("data/LoanStats3a_securev1.csv", header = TRUE, 
                    stringsAsFactors = F, skip = 1)

#get rid of fields that are 80% NA
poor_coverage <- sapply(df, function(x) {
  coverage <- 1 - sum(is.na(x)) / length(x)
  coverage < 0.8
})
df <- df[,poor_coverage==FALSE]

# delete columns that are not going to help
col_to_delete <- c("id", "member_id", "funded_amnt", "funded_amnt_inv", "int_rate",
                   "installment", "emp_title", "verification_status", "issue_d",
                   "pymnt_plan", "url", "desc", "purpose", "title", "zip_code",
                   "initial_list_status", "out_prncp", "out_prncp_inv", 
                   "total_pymnt", "total_pymnt_inv",
                   "total_rec_prncp", "total_rec_int", "total_rec_late_fee",
                   "recoveries", "collection_recovery_fee", "last_pymnt_d",
                   "last_pymnt_amnt", "next_pymnt_d", "last_credit_pull_d",
                   "last_fico_range_high", "last_fico_range_low", "application_type",
                   "policy_code", "earliest_cr_line", "grade", "sub_grade")
df <- df %>% select(-one_of(col_to_delete))

# clean up emp_length column
df$emp_length <- str_match(df$emp_length, "[0123456789+]")
df$emp_length <- as.numeric(df$emp_length)

# remove '%' from revol_util
df$revol_util <- gsub("%", "", df$revol_util)

# average fico high and low
df <- df %>% 
  mutate(fico = (fico_range_high + fico_range_low) / 2) %>%
  select(-c(fico_range_high, fico_range_low)) 

# Remove all remaining rows with NA's
df <- na.omit(df)

# may want to experiment with removing late
# create a good / bad column
# bad if late more than 30 days, in default, or charged off
bad_indicators <- c("Late (31-120 days)", "Default", "Charged Off")
df <- df %>% 
  mutate(is_bad = ifelse(df$loan_status %in% bad_indicators, 1, 0)) %>%
  select(-loan_status)

# remove "months" from the term column
df$term <- str_match(df$term, "[0123456789+]")

# remove columns which are all zeros
all_zeros <- sapply(df, function(x) {
  col_sum = 1
  if (is.numeric(x)){
      col_sum = sum(x)
  }
  col_sum == 0
})
df <- df[,all_zeros==FALSE]
```
